{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">{{ _('Projects') }}</h2>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>{{ _('Name') }}</th>
                        <th>{{ _('Created') }}</th>
                        <th>{{ _('Type') }}</th>
                        <th>{{ _('Status') }}</th>
                        <th>{{ _('Frames') }}</th>
                        <th>{{ _('FPS') }}</th>
                        <th>{{ _('Resolution') }}</th>
                        <th>{{ _('Codec') }}</th>
                        <th>{{ _('Duration') }}</th>
                        <th>{{ _('Proc. Time') }}</th>
                        <th>{{ _('Expires In') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects.items %}
                    <tr>
                        <td>{{ project.name }}</td>
                        <td data-timestamp="{{ project.created_at.timestamp() }}">
                            {{ project.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td>{{ project.csv_type }}</td>
                        <td>
                            <span class="badge text-bg-{{ 
                                'warning' if project.status == 'processing' else
                                'success' if project.status == 'completed' else
                                'danger' if project.status == 'error' else
                                'secondary' 
                            }}"
                            data-project-id="{{ project.id }}"
                            data-project-status="{{ project.status }}"
                            {% if project.status == 'error' and project.error_message %}
                            title="{{ project.error_message }}"
                            {% endif %}
                            >{{ _(project.status.capitalize()) }}
                            {% if project.status == 'processing' %}
                            ({{ "%d"|format(project.progress) }}%)
                            {% endif %}
                            </span>
                        </td>
                        <td>{{ project.frame_count }}</td>
                        <td>{{ project.fps }}</td>
                        <td>{{ project.resolution|upper if project.resolution else '-' }}</td>
                        <td>{{ project.codec|upper if project.codec else '-' }}</td>
                        <td>{{ project.get_duration_str() }}</td>
                        <td>{{ project.get_processing_time_str() }}</td>
                        <td>{{ project.time_until_expiry() }}</td>
                        <td>
                            <a href="{{ url_for('download_file', project_id=project.id, type='processed_csv') }}" 
                               class="btn btn-sm btn-info">
                                <i class="bi bi-download"></i> {{ _('CSV') }}
                            </a>
                            {% if project.status == 'completed' %}
                            <button onclick="downloadPngArchive({{ project.id }})" 
                                    class="btn btn-sm btn-warning" 
                                    id="png-btn-{{ project.id }}"
                                    data-archive-status="{{ project.png_archive_status or 'not_created' }}">
                                <i class="bi bi-download" id="png-icon-{{ project.id }}"></i> 
                                <span id="png-text-{{ project.id }}">{{ _('PNG') }}</span>
                            </button>
                            {% endif %}
                            {% if project.video_file %}
                            <a href="{{ url_for('download_file', project_id=project.id, type='video') }}" 
                               class="btn btn-sm btn-success">
                                <i class="bi bi-download"></i> {{ _('Video') }}
                            </a>
                            {% endif %}
                            {% if project.status == 'processing' %}
                            <button onclick="stopProject({{ project.id }})" 
                                    class="btn btn-sm btn-warning">
                                <i class="bi bi-stop-circle"></i> {{ _('Stop') }}
                            </button>
                            {% else %}
                            <button onclick="deleteProject({{ project.id }})" 
                                    class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i> {{ _('Delete') }}
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if projects.pages > 1 %}
        <nav aria-label="Project navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if projects.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('list_projects', page=projects.prev_num) }}">{{ _('Previous') }}</a>
                </li>
                {% endif %}

                {# Always show first page #}
                {% if projects.page > 2 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('list_projects', page=1) }}">1</a>
                </li>
                {% if projects.page > 3 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endif %}

                {# Show current page and adjacent pages #}
                {% for page_num in range(projects.page - 1, projects.page + 2) %}
                    {% if page_num > 0 and page_num <= projects.pages %}
                    <li class="page-item {% if page_num == projects.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('list_projects', page=page_num) }}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {# Always show last page #}
                {% if projects.page < projects.pages - 1 %}
                {% if projects.page < projects.pages - 2 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('list_projects', page=projects.pages) }}">{{ projects.pages }}</a>
                </li>
                {% endif %}

                {% if projects.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('list_projects', page=projects.next_num) }}">{{ _('Next') }}</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Convert UTC timestamps to local time
    document.querySelectorAll('td[data-timestamp]').forEach(function(td) {
        const timestamp = parseFloat(td.dataset.timestamp);
        const date = new Date(timestamp * 1000); // Convert to milliseconds
        td.textContent = date.toLocaleString();
    });

    // Initialize PNG buttons status
    updateAllPngButtonStatuses();
});

function downloadPngArchive(projectId) {
    const btn = document.getElementById(`png-btn-${projectId}`);
    const icon = document.getElementById(`png-icon-${projectId}`);
    const text = document.getElementById(`png-text-${projectId}`);
    
    // Disable button temporarily
    btn.disabled = true;
    
    fetch(`/download/${projectId}/png_archive`)
        .then(response => {
            if (response.ok && response.headers.get('content-type') === 'application/zip') {
                // File is ready, download it
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = response.headers.get('content-disposition')?.split('filename=')[1] || `project_${projectId}_frames.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    btn.disabled = false;
                });
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.message) {
                // Archive creation started
                icon.className = 'bi bi-clock';
                text.textContent = '{{ _("Creating...") }}';
                btn.className = 'btn btn-sm btn-warning';
                
                // Start polling for status
                pollArchiveStatus(projectId);
            } else if (data && data.error) {
                alert(data.error);
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ _("Error downloading archive") }}');
            btn.disabled = false;
        });
}

function pollArchiveStatus(projectId) {
    const checkStatus = () => {
        fetch(`/archive_status/${projectId}`)
            .then(response => response.json())
            .then(data => {
                updatePngButtonStatus(projectId, data.archive_status);
                
                if (data.archive_status === 'creating') {
                    // Continue polling
                    setTimeout(checkStatus, 2000);
                } else if (data.archive_status === 'ready') {
                    // Archive is ready, try to download again
                    setTimeout(() => downloadPngArchive(projectId), 500);
                } else if (data.archive_status === 'error') {
                    alert('{{ _("Failed to create archive. Please try again.") }}');
                } else if (data.archive_status === 'too_large') {
                    const errorMessage = data.error_message || '{{ _("Archive is too large for download (>100 MB). Please reduce the number of frames or video duration.") }}';
                    alert(errorMessage);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                setTimeout(checkStatus, 5000); // Retry after 5 seconds
            });
    };
    
    setTimeout(checkStatus, 2000);
}

function updatePngButtonStatus(projectId, status) {
    const btn = document.getElementById(`png-btn-${projectId}`);
    const icon = document.getElementById(`png-icon-${projectId}`);
    const text = document.getElementById(`png-text-${projectId}`);
    
    if (!btn) return;
    
    btn.dataset.archiveStatus = status;
    
    switch(status) {
        case 'ready':
            btn.className = 'btn btn-sm btn-warning';
            icon.className = 'bi bi-download';
            text.textContent = '{{ _("PNG") }}';
            btn.disabled = false;
            break;
        case 'creating':
            btn.className = 'btn btn-sm btn-warning';
            icon.className = 'bi bi-clock';
            text.textContent = '{{ _("Creating...") }}';
            btn.disabled = true;
            break;
        case 'error':
            btn.className = 'btn btn-sm btn-danger';
            icon.className = 'bi bi-exclamation-triangle';
            text.textContent = '{{ _("Error") }}';
            btn.disabled = false;
            break;
        case 'too_large':
            btn.className = 'btn btn-sm btn-secondary';
            icon.className = 'bi bi-file-earmark-x';
            text.textContent = '{{ _("Too Large") }}';
            btn.disabled = true;
            break;
        default: // not_created
            btn.className = 'btn btn-sm btn-warning';
            icon.className = 'bi bi-download';
            text.textContent = '{{ _("PNG") }}';
            btn.disabled = false;
            break;
    }
}

function updateAllPngButtonStatuses() {
    document.querySelectorAll('[id^="png-btn-"]').forEach(btn => {
        const projectId = btn.id.replace('png-btn-', '');
        const currentStatus = btn.dataset.archiveStatus;
        
        if (currentStatus === 'creating') {
            // Check current status
            fetch(`/archive_status/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    updatePngButtonStatus(projectId, data.archive_status);
                    if (data.archive_status === 'creating') {
                        pollArchiveStatus(projectId);
                    }
                })
                .catch(error => console.error('Error checking status:', error));
        } else {
            updatePngButtonStatus(projectId, currentStatus);
        }
    });
}
</script>
{% endblock %}