{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">{{ _('Create New Project') }}</h2>
            </div>
            <div class="card-body">
                <form id="uploadForm">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">{{ _('Project Name') }}</label>
                        <input type="text" class="form-control" id="projectName" name="project_name" 
                               placeholder="{{ _('Leave empty for auto-generation') }}">
                        <div id="projectNameFeedback" class="invalid-feedback">
                            {{ _('Project name can only contain letters and numbers (max 7 characters)') }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="csvFile" class="form-label">{{ _('CSV File') }}</label>
                        <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('Resolution') }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="resolution" id="fullhd" value="fullhd" checked>
                            <label class="form-check-label" for="fullhd">
                                {{ _('Full HD (1920x1080)') }}
                                <span class="badge text-bg-success">{{ _('Fast') }}</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="resolution" id="4k" value="4k">
                            <label class="form-check-label" for="4k">
                                {{ _('4K (3840x2160)') }}
                                <span class="badge text-bg-danger">{{ _('Slow') }}</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('FPS') }}</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="fps" id="fps14985" value="14.985" checked>
                            <label class="form-check-label" for="fps14985">
                                14.985 (insta360, GoPro)
                                <span class="badge text-bg-success">{{ _('Fast') }}</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="fps" id="fps23976" value="23.976">
                            <label class="form-check-label" for="fps23976">
                                23.976
                                <span class="badge text-bg-warning">{{ _('Medium') }}</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="fps" id="fps29970" value="29.97">
                            <label class="form-check-label" for="fps29970">
                                29.97
                                <span class="badge text-bg-danger">{{ _('Slow') }}</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="interpolateValues" name="interpolate_values" checked>
                        <label class="form-check-label" for="interpolateValues">
                            {{ _('Interpolate data values (smooths the display of telemetry)') }}
                        </label>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" id="uploadButton" class="btn btn-primary">{{ _('Upload CSV') }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4" id="previewSection" style="display: none;">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">{{ _('Preview') }}</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <img id="previewImage" src="" alt="Preview" class="img-fluid shadow-sm">
                    </div>
                    <div class="col-lg-6 mb-4">
                        <!-- Preset Management -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">{{ _('Preset Management') }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <select class="form-select me-2" id="presetSelect">
                                        <option value="">{{ _('Select a preset...') }}</option>
                                    </select>
                                    <button type="button" class="btn btn-sm btn-danger" id="deletePresetButton" disabled>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="btn-group w-100">
                                    <button type="button" class="btn btn-warning" id="resetDefaultsButton">{{ _('Reset to defaults') }}</button>
                                    <button type="button" class="btn btn-primary" id="savePresetButton" data-bs-toggle="modal" data-bs-target="#savePresetModal">{{ _('Save current settings') }}</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trim CSV Data section -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">{{ _('Trim CSV Data') }}</h5>
                            </div>
                            <div class="card-body">
                                <div id="loadingTrimData" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">{{ _('Loading...') }}</span>
                                    </div>
                                    <p>{{ _('Loading data...') }}</p>
                                </div>
                                
                                <div id="trimDataContent" style="display: none;">
                                    <div class="mb-3">
                                        <div id="dataChart" style="height: 120px;"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="trimRangeSlider" class="form-label">{{ _('Select Time Range') }}</label>
                                        <div class="d-flex align-items-center mb-2">
                                            <input type="text" id="startTimeDisplay" class="form-control form-control-sm me-2" readonly>
                                            <span class="mx-2">-</span>
                                            <input type="text" id="endTimeDisplay" class="form-control form-control-sm ms-2" readonly>
                                        </div>
                                        <div id="trimRangeSlider"></div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>{{ _('Total records:') }} <span id="totalRecords">0</span></span>
                                        <span>{{ _('Selected:') }} <span id="selectedRecords">0</span></span>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" id="trimDataButton">{{ _('Apply Trim') }}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion control settings -->
                <div class="accordion mb-4" id="settingsAccordion">
                    <!-- Position Settings -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="positionSettingsHeading">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#positionSettingsCollapse" aria-expanded="true" aria-controls="positionSettingsCollapse">
                                {{ _('Position Settings') }}
                            </button>
                        </h2>
                        <div id="positionSettingsCollapse" class="accordion-collapse collapse show" aria-labelledby="positionSettingsHeading">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="verticalPosition" class="form-label">{{ _('Vertical Position') }}</label>
                                        <input type="range" class="form-range" id="verticalPosition" min="0" max="100" value="50">
                                        <div class="d-flex justify-content-between">
                                            <span>{{ _('Top') }}</span>
                                            <span>{{ _('Bottom') }}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="topPadding" class="form-label">{{ _('Top Padding') }}</label>
                                        <input type="range" class="form-range" id="topPadding" min="0" max="50" value="10">
                                        <div class="d-flex justify-content-between">
                                            <span>0px</span>
                                            <span>50px</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="bottomPadding" class="form-label">{{ _('Bottom Padding') }}</label>
                                        <input type="range" class="form-range" id="bottomPadding" min="0" max="50" value="30">
                                        <div class="d-flex justify-content-between">
                                            <span>0px</span>
                                            <span>50px</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="spacing" class="form-label">{{ _('Item Spacing') }}</label>
                                        <input type="range" class="form-range" id="spacing" min="5" max="50" value="20">
                                        <div class="d-flex justify-content-between">
                                            <span>5px</span>
                                            <span>50px</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Design Settings -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="designSettingsHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#designSettingsCollapse" aria-expanded="false" aria-controls="designSettingsCollapse">
                                {{ _('Design Settings') }}
                            </button>
                        </h2>
                        <div id="designSettingsCollapse" class="accordion-collapse collapse" aria-labelledby="designSettingsHeading">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="fontSize" class="form-label">{{ _('Font Size') }}</label>
                                        <input type="range" class="form-range" id="fontSize" min="12" max="48" value="26">
                                        <div class="d-flex justify-content-between">
                                            <span>12px</span>
                                            <span>48px</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="borderRadius" class="form-label">{{ _('Border Radius') }}</label>
                                        <input type="range" class="form-range" id="borderRadius" min="0" max="25" value="13">
                                        <div class="d-flex justify-content-between">
                                            <span>0px</span>
                                            <span>25px</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Speed Indicator Settings -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="speedIndicatorHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#speedIndicatorCollapse" aria-expanded="false" aria-controls="speedIndicatorCollapse">
                                {{ _('Speed Indicator Settings') }}
                            </button>
                        </h2>
                        <div id="speedIndicatorCollapse" class="accordion-collapse collapse" aria-labelledby="speedIndicatorHeading">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="indicatorX" class="form-label">{{ _('Horizontal Position') }}</label>
                                        <input type="range" class="form-range" id="indicatorX" min="0" max="100" value="50">
                                        <div class="d-flex justify-content-between">
                                            <span>{{ _('Left') }}</span>
                                            <span>{{ _('Right') }}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="indicatorY" class="form-label">{{ _('Vertical Position') }}</label>
                                        <input type="range" class="form-range" id="indicatorY" min="0" max="100" value="80">
                                        <div class="d-flex justify-content-between">
                                            <span>{{ _('Top') }}</span>
                                            <span>{{ _('Bottom') }}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="speedY" class="form-label">{{ _('Speed Vertical Offset') }}</label>
                                        <input type="range" class="form-range" id="speedY" min="-50" max="50" value="0">
                                        <div class="d-flex justify-content-between">
                                            <span>-50px</span>
                                            <span>+50px</span>
                                        </div>
                                        <div class="text-muted small">{{ _('Current:') }} <span id="speedYValue">0</span>{{ _('px') }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="unitY" class="form-label">{{ _('Unit Vertical Offset') }}</label>
                                        <input type="range" class="form-range" id="unitY" min="-50" max="50" value="0">
                                        <div class="d-flex justify-content-between">
                                            <span>-50px</span>
                                            <span>+50px</span>
                                        </div>
                                        <div class="text-muted small">{{ _('Current:') }} <span id="unitYValue">0</span>{{ _('px') }}</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="speedSize" class="form-label">{{ _('Speed Size') }}</label>
                                        <input type="range" class="form-range" id="speedSize" min="50" max="200" value="100">
                                        <div class="d-flex justify-content-between">
                                            <span>50%</span>
                                            <span>200%</span>
                                        </div>
                                        <div class="text-muted small">{{ _('Current:') }} <span id="speedSizeValue">100</span>%</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="unitSize" class="form-label">{{ _('Unit Size') }}</label>
                                        <input type="range" class="form-range" id="unitSize" min="50" max="200" value="100">
                                        <div class="d-flex justify-content-between">
                                            <span>50%</span>
                                            <span>200%</span>
                                        </div>
                                        <div class="text-muted small">{{ _('Current:') }} <span id="unitSizeValue">100</span>%</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="indicatorScale" class="form-label">{{ _('Scale') }}</label>
                                        <input type="range" class="form-range" id="indicatorScale" min="50" max="150" value="100">
                                        <div class="d-flex justify-content-between">
                                            <span>50%</span>
                                            <span>150%</span>
                                        </div>
                                        <div class="text-muted small">{{ _('Current:') }} <span id="indicatorScaleValue">100</span>%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Telemetry Elements Visibility Settings -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="telemetryElementsHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#telemetryElementsCollapse" aria-expanded="false" aria-controls="telemetryElementsCollapse">
                                {{ _('Telemetry Elements Visibility') }}
                            </button>
                        </h2>
                        <div id="telemetryElementsCollapse" class="accordion-collapse collapse" aria-labelledby="telemetryElementsHeading">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showSpeed" checked>
                                                <label class="form-check-label" for="showSpeed">
                                                    {{ _('Speed') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showMaxSpeed" checked>
                                                <label class="form-check-label" for="showMaxSpeed">
                                                    {{ _('Max Speed') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showVoltage" checked>
                                                <label class="form-check-label" for="showVoltage">
                                                    {{ _('Voltage') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showTemp" checked>
                                                <label class="form-check-label" for="showTemp">
                                                    {{ _('Temperature') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showBattery" checked>
                                                <label class="form-check-label" for="showBattery">
                                                    {{ _('Battery') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showGPS">
                                                <label class="form-check-label" for="showGPS">
                                                    {{ _('GPS') }}
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showMileage" checked>
                                                <label class="form-check-label" for="showMileage">
                                                    {{ _('Mileage') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showPWM" checked>
                                                <label class="form-check-label" for="showPWM">
                                                    {{ _('PWM') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showPower" checked>
                                                <label class="form-check-label" for="showPower">
                                                    {{ _('Power') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showCurrent" checked>
                                                <label class="form-check-label" for="showCurrent">
                                                    {{ _('Current') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showBottomElements" checked>
                                                <label class="form-check-label" for="showBottomElements">
                                                    {{ _('Bottom Elements') }}
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row align-items-end">
                    <div class="col-md-4 mb-3">
                        <label for="codec" class="form-label">{{ _('Video Codec') }}</label>
                        <select class="form-select" id="codec">
                            <option value="h264" selected>{{ _('H.264 (Fast, Compatible)') }}</option>
                            <option value="h265">{{ _('H.265 (Better quality, Slower)') }}</option>
                        </select>
                    </div>
                    <div class="col-md-8 mb-3 d-grid">
                        <button type="button" class="btn btn-success" id="startProcessButton">{{ _('Start Processing') }}</button>
                    </div>
                </div>

                <div id="processingProgress" style="display: none;" class="mt-4">
                    <div class="d-flex justify-content-between mb-2">
                        <h5 id="progressTitle">{{ _('Processing...') }}</h5>
                        <button type="button" class="btn btn-sm btn-danger" id="stopProcessingButton">{{ _('Stop Processing') }}</button>
                    </div>
                    <div class="progress mb-2">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="progressDetails" class="small text-muted mb-2">
                        <span id="framesProcessed">0</span> {{ _('frames of') }} <span id="totalFrames">0</span> (0%)
                    </div>
                    <div id="processingTime" class="small text-muted mb-2">
                        {{ _('Processing time:') }} <span id="elapsedTime">0</span>
                    </div>
                    <div id="videoProcessingInfo" class="small text-muted"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Save Preset Modal -->
<div class="modal fade" id="savePresetModal" tabindex="-1" aria-labelledby="savePresetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savePresetModalLabel">{{ _('Save Preset') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="presetName" class="form-label">{{ _('Preset Name') }}</label>
                    <input type="text" class="form-control" id="presetName" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" id="confirmSavePreset">{{ _('Save') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal for CSV files that are too long -->
<div class="modal fade" id="csvTooLongModal" tabindex="-1" aria-labelledby="csvTooLongModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="csvTooLongModalLabel">{{ _('Warning: CSV File Too Long') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="csvTooLongModalBody">
                <!-- Error message will be inserted here by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">{{ _('OK') }}</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0"></script>
<script src="{{ url_for('static', filename='js/upload.js') }}"></script>
{% endblock %}
